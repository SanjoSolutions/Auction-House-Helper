-- We should probably move this into another file too
local MESSAGES = {
  {
    Version = "10.0.15",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_100015_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_5,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_ALL_VERSIONS_6,
        },
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_100015_RETAIL_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_RETAIL_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_RETAIL_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_RETAIL_3,
        },
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_5,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_6,
          AUCTION_HOUSE_HELPER_L_SPLASH_100015_CLASSIC_7,
        },
      },
    },
  },
  {
    Version = "9.2.25",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_9225_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9225_ALL_VERSIONS_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_ALL_VERSIONS_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_ALL_VERSIONS_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_ALL_VERSIONS_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_ALL_VERSIONS_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_ALL_VERSIONS_5,
        },
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9225_RETAIL_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_RETAIL_1,
        },
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9225_CLASSIC_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_CLASSIC_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_CLASSIC_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_CLASSIC_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_CLASSIC_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_9225_CLASSIC_5,
        },
      },
    },
  },
  {
    Version = "9.1.8",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_9108_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_5,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_6,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_7,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_8,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_9,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_10,
          AUCTION_HOUSE_HELPER_L_SPLASH_9108_FEATURES_11,
        },
      },
    },
  },
  {
    Version = "9.1.6",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_9106_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9106_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9106_FEATURES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_9106_FEATURES_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_9106_FEATURES_3,
        }
      },
    }
  },
  {
    Version = "9.1.5",
    Description = "",
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9105_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9105_FEATURES_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_9105_FEATURES_3,
        }
      },
    }
  },
  {
    Version = "9.0.10",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_9010_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9010_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9010_FEATURES_1,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_9010_UNANNOUNCED_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_9010_UNANNOUNCED_1,
        }
      },
    }
  },
  {
    Version = "9.0.7",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_907_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_907_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_907_FEATURES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_907_FEATURES_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_907_FEATURES_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_907_FEATURES_4,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_907_UNANNOUNCED_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_907_UNANNOUNCED_1,
        }
      },
    }
  },
  {
    Version = "9.0.5",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_905_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_905_UPDATES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_905_UPDATES_1,
        }
      },
    }
  },
  {
    Version = "9.0.4",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_904_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_904_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_904_FEATURES_1,
        }
      },
    }
  },
  {
    Version = "9.0.3",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_903_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_903_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_903_FEATURES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_903_FEATURES_2,
        }
      },
    }
  },
  {
    Version = "9.0.2",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_902_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_902_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_902_FEATURES_1,
        }
      },
    }
  },
  {
    Version = "9.0.1",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_901_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_901_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_901_FEATURES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_901_FEATURES_2,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_901_CHANGES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_901_CHANGES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_901_CHANGES_2,
        }
      },
    }
  },
  {
    Version = "8.3.4",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_834_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_834_SHOPPING_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_834_SHOPPING_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_834_SHOPPING_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_834_SHOPPING_3,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_834_SELLING_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_834_SELLING_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_834_SELLING_2,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_834_MISCELLANEOUS_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_834_MISCELLANEOUS_1,
        }
      },
    }
  },
  {
    Version = "8.3.3",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_833_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_833_SELLING_IMPROVEMENTS_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_833_SELLING_IMPROVEMENTS_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_833_SELLING_IMPROVEMENTS_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_833_SELLING_IMPROVEMENTS_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_833_SELLING_IMPROVEMENTS_4,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_833_CONNECTED_REALMS_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_833_CONNECTED_REALMS_1,
        }
      },
    }
  },
  {
    Version = "8.3.2",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_832_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_5,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_6,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_FEATURES_7,
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_832_CUSTOMISATION_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_832_CUSTOMISATION_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_CUSTOMISATION_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_CUSTOMISATION_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_CUSTOMISATION_4,
          AUCTION_HOUSE_HELPER_L_SPLASH_832_CUSTOMISATION_5,
        }
      },
    }
  },
  {
    Version = "8.3.1",
    Description = nil,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_831_CANCELLING,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_831_CANCELLING_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_831_CANCELLING_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_831_CANCELLING_3,
        }
      },
    }
  },
  {
    Version = "8.3.0",
    Description = AUCTION_HOUSE_HELPER_L_SPLASH_830_DESCRIPTION,
    Sections = {
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_830_BUGS_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_830_BUGS_1:format("https://tinyurl.com/AuctionHouseHelperDiscord"),
          AUCTION_HOUSE_HELPER_L_SPLASH_830_BUGS_2:format("https://tinyurl.com/AuctionHouseHelperBug"),
          AUCTION_HOUSE_HELPER_L_SPLASH_830_BUGS_3,
          AUCTION_HOUSE_HELPER_L_SPLASH_830_BUGS_4:format("https://tinyurl.com/AuctionHouseHelper83Release")
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_830_DONE_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_830_DONE_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_830_DONE_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_830_DONE_3
        }
      },
      {
        Title = AUCTION_HOUSE_HELPER_L_SPLASH_830_NOT_DONE_HEADER,
        Entries = {
          AUCTION_HOUSE_HELPER_L_SPLASH_830_NOT_DONE_1,
          AUCTION_HOUSE_HELPER_L_SPLASH_830_NOT_DONE_2,
          AUCTION_HOUSE_HELPER_L_SPLASH_830_NOT_DONE_3
        }
      }
    }
  },
}

local NEW_MESSAGE_FONTS = {
  entry = GameFontHighlight,
  title = GameFontNormal,
  description = GameFontHighlight,
  version = GameFontNormalHuge
}

local VIEWED_MESSAGE_FONTS = {
  entry = GameFontDisable,
  title = GameFontDisable,
  description = GameFontDisable,
  version = GameFontDisableHuge
}

local STRING_WIDTH = 550

AuctionHouseHelperSplashScreenMixin = {}

function AuctionHouseHelperSplashScreenMixin:OnLoad()
  AuctionHouseHelper.Debug.Message("AuctionHouseHelperSplashScreenMixin:OnLoad()")

  --Trap mouse events (prevents click-through the frame)
  self:EnableMouse(true)

  local view = CreateScrollBoxLinearView()
  view:SetPadding(0, 25, 10, 10, 0)
  view:SetPanExtent(50)
  ScrollUtil.InitScrollBoxWithScrollBar(self.ScrollBox, self.ScrollBar, view);

  self.ScrollBox.Content.OnCleaned = function()
    self.ScrollBox:FullUpdate(ScrollBoxConstants.UpdateImmediately);
  end

  table.insert(UISpecialFrames, self:GetName())

  self:ReformatCheckbox()
  self:CreateMessagesText()

  self:ShowIfNeeded()
end

function AuctionHouseHelperSplashScreenMixin:OnShow()
  AuctionHouseHelper.Config.Set(AuctionHouseHelper.Config.Options.SPLASH_SCREEN_VERSION, MESSAGES[1].Version)
end

function AuctionHouseHelperSplashScreenMixin:ReformatCheckbox()
  self.HideCheckbox.CheckBox:SetSize(28, 28)
  self.HideCheckbox.CheckBox:SetScript("OnClick", function()
    AuctionHouseHelper.Config.Set(
      AuctionHouseHelper.Config.Options.HIDE_SPLASH_SCREEN,
      self.HideCheckbox.CheckBox:GetChecked()
    )
  end)

  self.HideCheckbox.CheckBox.Label:SetPoint("TOPLEFT", self.HideCheckbox.CheckBox, "TOPRIGHT", 3, -7 )
end

function AuctionHouseHelperSplashScreenMixin:ShowIfNeeded()
  local lastViewedSplashScreenVersion = AuctionHouseHelper.Config.Get(AuctionHouseHelper.Config.Options.SPLASH_SCREEN_VERSION)
  local mostRecentSplashScreenVersion = self:GetMostRecentVersion()

  if lastViewedSplashScreenVersion ~= mostRecentSplashScreenVersion then
    AuctionHouseHelper.Config.Set(
      AuctionHouseHelper.Config.Options.HIDE_SPLASH_SCREEN,
      false
    )
  end

  if not AuctionHouseHelper.Config.Get(AuctionHouseHelper.Config.Options.HIDE_SPLASH_SCREEN) then
    self:Show()
  end
end

function AuctionHouseHelperSplashScreenMixin:GetMostRecentVersion()
  return MESSAGES[1].Version
end

function AuctionHouseHelperSplashScreenMixin:CreateMessagesText()
  local lastVersion = AuctionHouseHelper.Config.Get(AuctionHouseHelper.Config.Options.SPLASH_SCREEN_VERSION)
  local fonts = NEW_MESSAGE_FONTS

  local previous
  local current

  for _, messageSpec in ipairs(MESSAGES) do
    -- Gray out previously viewed versions
    if lastVersion == messageSpec.Version then
      fonts = VIEWED_MESSAGE_FONTS
    end

    -- Add version string
    current = self:CreateString(messageSpec.Version, fonts.version, previous, -30)
    previous = current

    -- Add description string
    if messageSpec.Description ~= nil then
      current = self:CreateString(messageSpec.Description, fonts.description, previous)
      previous = current
    end

    -- Add sections
    for _, section in ipairs(messageSpec.Sections or {}) do
      current = self:CreateString(section.Title, fonts.title, previous, -8)
      previous = current

      for _, entry in ipairs(section.Entries) do
        current = self:CreateBulletedString(entry, fonts.entry, previous)
        previous = current
      end
    end
  end

  self.ScrollBox.Content:SetWidth(600)
  self.ScrollBox.Content:MarkDirty()
end

function AuctionHouseHelperSplashScreenMixin:CreateString(text, font, previousElement, offset)
  local entry = self.ScrollBox.Content:CreateFontString(nil, "ARTWORK")

  if offset == nil then
    offset = -5
  end

  entry:SetFontObject(font)
  entry:SetText(text)
  entry:SetJustifyH("LEFT")
  entry:SetWidth(STRING_WIDTH)

  if previousElement ~= nil then
    entry:SetPoint("TOPLEFT", previousElement, "BOTTOMLEFT", 0, offset)
  else
    entry:SetPoint("TOPLEFT", self.ScrollBox.Content, "TOPLEFT", 0, -10)
  end

  return entry
end

-- Did this just to get nice alignment on the bulleted entries (otherwise the text wrapped below the bullet)
function AuctionHouseHelperSplashScreenMixin:CreateBulletedString(text, font, previousElement, offset)
  local bullet = self:CreateString("* ", font, previousElement, offset)
  bullet:SetWidth(20)
  bullet:SetJustifyV("TOP")

  local entry = self:CreateString(text, font, previousElement, offset)
  entry:SetPoint("TOPLEFT", bullet, "TOPRIGHT")
  entry:SetWidth(STRING_WIDTH - 20)

  bullet:SetHeight(entry:GetStringHeight())

  return bullet
end
